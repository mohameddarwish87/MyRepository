{
	"name": "SP_LoadLink_Notification_Connection",
	"properties": {
		"folder": {
			"name": "ws-ent-syn-serverlessdb-001/StoredProcedure"
		},
		"content": {
			"query": "/****** Object:  StoredProcedure [dbo].[SP_LoadLink_Notification_Connection]    Script Date: 12/22/2022 5:14:37 AM ******/\nSET ANSI_NULLS ON\nGO\n\nSET QUOTED_IDENTIFIER ON\nGO\n\n\n\nCREATE OR ALTER   PROCEDURE [dbo].[SP_LoadLink_Notification_Connection]\n(\n@GetNewWaterMark bit=0,@RowValidFrom Datetime2(7)='1900-01-01 00:00:00.0000000'\n)\nas\nBegin \n\tIF @GetNewWaterMark>0\n\tBEGIN\n\tSELECT isnull(max(RowValidFrom),@RowValidFrom) AS RowValidFrom\n\t\t\tFROM [dbo].[ws_notification]\n\t\t\tWHERE CAST(RowValidFrom As datetime2(7))>@RowValidFrom\n\tEND\n\tELSE\nWITH cte_connection\n     AS (SELECT [record1id]                      AS 'NotificationID',\n                [record2id]                      AS 'ConnectionID',\n                [record2roleidname]              AS 'Role',\n                record2id_entitytype             AS 'EntityType',\n\t\t\t\tisnull([description],'')         As 'Description',\n                Row_number()\n                  OVER (\n                    partition BY id\n                    ORDER BY versionnumber DESC) AS ROW_RUM\n         FROM   [dbo].[connection] Conn\n         WHERE  record1id_entitytype = 'ws_notification' and record2id_entitytype!='systemuser'\n         AND  CAST(Conn.RowValidFrom as datetime2(7)) > @RowValidFrom \n         UNION\n         SELECT [id]                             AS 'NotificationID',\n                [ws_primarypcbu]                 AS 'ConnectionID',\n                'Primary PCBU'                   AS 'Role',\n                [ws_primarypcbu_entitytype]      AS 'EntityType',\n\t\t\t\t''                               As 'Description',\n                Row_number()\n                  OVER (\n                    partition BY id\n                    ORDER BY versionnumber DESC) AS ROW_RUM\n         FROM   [dbo].[ws_notification] a\n         WHERE  [ws_primarypcbu] IS NOT NULL\n         AND  CAST(a.RowValidFrom as datetime2(7)) > @RowValidFrom \n        \n         UNION\n         SELECT [id]                             AS 'NotificationID',\n                [ws_primaryparty]                AS 'ConnectionID',\n                'Primary Party'                  AS 'Role',\n                [ws_primaryparty_entitytype]     AS 'EntityType',\n\t\t\t\t''                               As 'Description',\n                Row_number()\n                  OVER (\n                    partition BY id\n                    ORDER BY versionnumber DESC) AS ROW_RUM\n         FROM   [dbo].[ws_notification] a\n         WHERE  [ws_primaryparty] IS NOT NULL \n         AND  CAST(a.RowValidFrom as datetime2(7)) > @RowValidFrom \n         AND a.RowIsCurrent='true'\n\n\t\n        )\n\t\t--,cte_victim\n  --   AS (SELECT [id]                             AS 'NotificationID',\n  --              NULL                             AS 'ConnectionID',\n  --              'Victim'                         AS 'Role',\n  --              NULL                             AS 'ConnectionType',\n  --              ws_victimfullname                AS 'Connection',\n\t\t--\t\t''                               As 'Description',\n  --              Row_number()\n  --                OVER (\n  --                  partition BY id\n  --                  ORDER BY versionnumber DESC) AS ROW_RUM\n  --       FROM   [dbo].[ws_notification])\n  \nSELECT NotificationID,\n       ConnectionID,\n       Role,\n       entitytype AS ConnectionType,\n       CASE\n         WHEN entitytype = 'account' THEN b.[businessname]\n         WHEN entitytype = 'contact' THEN c.[fullname]\n       END        AS Connection,\n\t   Description\nFROM   cte_connection Conn\n      left join  [Notification_DataMart].[Notification].[Dim_Contact] c\n              ON c.[contactid] = Conn.connectionid \n     left join  [Notification_DataMart].[Notification].[Dim_Business] b\n              ON b.[businessid] = Conn.connectionid \nWHERE  row_rum = 1  \n\nUNION \n\nSELECT \n'UNKNOWN',\n'UNKNOWN',\nNUll,\nNull,\nNull,\nNull\n\nEND\nGO\n\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "wsentsynserverlessdb001",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}