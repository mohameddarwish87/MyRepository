{
	"name": "dbo_SP_LoadFact_Covid19Notification",
	"properties": {
		"folder": {
			"name": "ws-ent-syn-serverlessdb-001/StoredProcedure"
		},
		"content": {
			"query": "/****** Object:  StoredProcedure [dbo].[SP_LoadFact_Covid19Notification]    Script Date: 12/22/2022 5:13:10 AM ******/\nSET ANSI_NULLS ON\nGO\n\nSET QUOTED_IDENTIFIER ON\nGO\n\n\n\n\nCREATE OR ALTER   PROCEDURE [dbo].[SP_LoadFact_Covid19Notification]\n( @GetNewWaterMark bit=0,@RowValidFrom Datetime2(7)='1900-01-01 00:00:00.0000000'\n)\nAS\nexec [dbo].[SP_LoadOptionSetName_All2] \"[wsentsynserverlessdb001]\",\"dbo\",\"ws_covid19notification\";\n\nBegin \n\tIF @GetNewWaterMark>0\n\tBEGIN\n\tSELECT isnull(max(RowValidFrom),@RowValidFrom) AS RowValidFrom\n\t\t\tFROM [dbo].[TMP_VIEW]\n\t\t\tWHERE CAST(RowValidFrom As datetime2(7))>@RowValidFrom\n\tEND\n\tELSE\n\nWITH CTE\nAS (\n\tSELECT ws_covid19notificationid AS [CovidNotificationID]\n\t\t,b.LocalizedLabel AS [Status]\n\t\t,C.LocalizedLabel AS [StatusReason]\n\t\t,ws_guardian AS [GuardianFileName]\n\t\t,ws_dateofnotification AS [NotificationDate]\n\t\t,ws_dateallocatedtocna AS [CNAAllocatedDate]\n\t\t,ws_dateallocatedtooffice [OfficeAllocatedDate]\n\t\t,ws_regionofbreach AS [BreachRegion]\n\t\t,ws_cityofbreach AS [BreachCity]\n\t\t,ws_dataandtimeofbreach [BreachDateTime]\n\t\t,localizedlabel_ws_trafficlightstatus AS [TrafficLightStatus]\n\t\t,ws_mbiepriority AS [MBIEPriority]\n\t\t,localizedlabel_ws_notificationpriority AS [NotificationPriority]\n\t\t,localizedlabel_ws_triageoutcome AS [TriageOutcome]\n\t\t,localizedlabel_ws_triageoutcomereason AS [TriageOutcomeReason]\n\t\t,ws_cannotidentifypcbu AS [CannotIdentifyPCBU]\n\t\t,ws_potentialexposure AS [PotentialExposuretothePublic]\n\t\t,ws_potentialexposurevulnerable AS [PotentialExposuretoVulnerablepopulations]\n\t\t,ws_declaration AS [Declaration]\n\t\t,ws_agreementonprivacystatement AS [AgreementOnPrivacyStatement]\n\t\t--Keys for Lookup\n\t\t\n\t\t,ws_relatedpcbu AS [RelatedPCBUAccount/ContactID] -- Account /Contact\n\t\t,ws_cna AS [NotificaitonAgentSystemUserID] --bring the name column\n\t\t,ws_contactpersonatpcbu AS [PCBUContactPersonID] --Contact\n\t\t\n\t\t,convert(DATETIMEOFFSET, [modifiedon]) AS [ModifiedDate]\n\t\t,convert(DATETIMEOFFSET, [createdon]) AS [CreatedDate]\n\t\t,createdbyname AS [CreatedBy]\n\t\t,modifiedbyname [ModifiedBy]\n\t\t,ROW_NUMBER() OVER (\n\t\t\tPARTITION BY ID ORDER BY versionnumber DESC\n\t\t\t) AS ROW_RUM\n\t\t\t,E.DLDim_OfficeKey  \n\t\t,F.[DLDim_BusinessKey]\n\t\t,G.DLDim_IndustryKey\n\t\t,H.[DLDim_Breach_CategoryKey]\n\t\t,I.[DLDim_Breach_TypeKey]\n\t\t,J.[DLDim_External_AgencyKey]\n\t\t,P.[DLDim_ContactKey]\n\tFROM [dbo].[TMP_VIEW] A--[dbo].ws_covid_notification A[dbo].[TMP_VIEW]\n\tLEFT JOIN [dbo].[StateMetadata] B ON A.statecode = b.STATE\n\t\tAND b.EntityName = 'ws_covid19notification'\n\t\tAND a.RowIsCurrent='true'\n\tLEFT JOIN [dbo].[StatusMetadata] C ON A.statuscode = C.STATUS\n\t\tAND c.EntityName = 'ws_covid19notification'\n\t\tAND a.RowIsCurrent='true'\n\t LEFT JOIN [Notification_DataMart].[Notification].[Dim_Office] E on A.ws_office=E.[OfficeID] AND E.RowIsCurrent='true'\n\t LEFT JOIN [Notification_DataMart].[Notification].[Dim_Business] F ON A.ws_relatedpcbu=F.[BusinessID] AND F.RowIsCurrent='true'\n\t LEFT JOIN [Notification_DataMart].[Notification].[Dim_Industry] G ON F.[BusinessIndustryID]=G.[IndustryID] AND G.RowIsCurrent='true'\n\t LEFT JOIN [Notification_DataMart].[Notification].[Dim_Breach_Category]H on H.[BreachCategoryID]=A.ws_categoryofbreach AND H.RowIsCurrent='true'\n\t LEFT JOIN [Notification_DataMart].[Notification].[Dim_Breach_Type] I on I.[BreachTypeID]=A.[ws_typeofbreach] AND I.RowIsCurrent='true'\n\t LEFT JOIN [Notification_DataMart].[Notification].[Dim_External_Agency]J on J.[ExternalAgencyID]=A.ws_triagedepartment AND J.RowIsCurrent='true'\n\t LEFT JOIN [Notification_DataMart].[Notification].[Dim_Contact] P ON p.[ContactID]=A.ws_relatedpcbu AND P.RowIsCurrent='true'\n\t\t\t\tWHERE CAST(a.RowValidFrom as datetime2(7)) > @RowValidFrom)\nSELECT \n\t [CovidNotificationID]\n\t,[Status]\n\t,[StatusReason]\n\t,[GuardianFileName]\n\t,[NotificationDate]\n\t,[CNAAllocatedDate]\n\t,[OfficeAllocatedDate]\n\t,[BreachRegion]\n\t,[BreachCity]\n\t,[BreachDateTime]\n\t,[TrafficLightStatus]\n\t,[MBIEPriority]\n\t,[NotificationPriority]\n\t,[TriageOutcome]\n\t,[TriageOutcomeReason]\n\t,[CannotIdentifyPCBU]\n\t,[PotentialExposuretothePublic]\n\t,[PotentialExposuretoVulnerablepopulations]\n\t,[Declaration]\n\t,[AgreementonPrivacyStatement]\n\t,[ModifiedDate]\n\t,[CreatedDate]\n\t,[CreatedBy]\n\t,[ModifiedBy]\n\t,[NotificaitonAgentSystemUserID]\n\t,[PCBUContactPersonID]\n\t,DLDim_OfficeKey\n\t,[DLDim_BusinessKey]\n\t,DLDim_IndustryKey\n\t,[DLDim_Breach_CategoryKey]\n\t,[DLDim_Breach_TypeKey]\n\t,[DLDim_External_AgencyKey]\n\t,[DLDim_ContactKey]\nFROM CTE\nWHERE ROW_RUM = 1 AND [CovidNotificationID] is not null\n\nUNION \n\nSELECT \n'UNKNOWN',\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull\nEND\nGO\n\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "wsentsynserverlessdb001",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}