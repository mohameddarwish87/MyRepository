{
	"name": "dbo_SP_LoadOptionSetName_All2",
	"properties": {
		"folder": {
			"name": "ws-ent-syn-serverlessdb-001/StoredProcedure"
		},
		"content": {
			"query": "/****** Object:  StoredProcedure [dbo].[SP_LoadOptionSetName_All2]    Script Date: 12/15/2022 4:31:29 AM ******/\nSET ANSI_NULLS ON\nGO\n\nSET QUOTED_IDENTIFIER ON\nGO\n\n\n\n\nCREATE or Alter PROCEDURE [dbo].[SP_LoadOptionSetName_All2] @DBName nvarchar(300), @SchemaName nvarchar(30),@TableName nvarchar(30)\nAS\n/***********************************************************************************************************************\n#**  Name:                   sp_LoadOptionSetName_All2 Stored Procedure\n#**  Desc:                   The Stored Procedure generates data from table passed to it plus additional lookupvalues of OptionSetName and put it in a dbo.tmp_view\n#**\t\t\t\t\t\t\t Example of execution is exec [dbo].[SP_LoadOptionSetName_All2] \"[ws-ent-syn-serverlessdb-001]\",\"dbo\",\"contact\"\n#**  Auth:                   M Darwish\n#**  Date:                   26/10/2022\n#**\n#**  Change History\n#**  --------------\n#**  No.     Date            Author              Description\n#**  ---     ----------      -----------         ---------------------------------------------------------------\n#**  1       26/10/2022      M Darwish            Original Version\n************************************************************************************************************************/\n--drop table #OptionSetName_tbl\nCREATE TABLE #OptionSetName_tbl\n(\t\n\tSequence1 int,\n\tColumnName varchar(200)\n);\n--exec [dbo].[SP_LoadOptionSetName_All2] 'dataverse_wsdttest_unq3f0c71de29f842399d828201e1474','dbo','contact'\n--Declare @SchemaName VARCHAR(100) = 'dbo';\n--Declare @TableName Varchar(100) = 'ws_covid_notification'--'ws_covid19notification';\n--Declare @DBName Varchar(300) = 'Test_Notification_DataMart'--'dataverse_wsdttest_unq3f0c71de29f842399d828201e1474';\nDeclare @GlobalOSPvt_SQL nvarchar(max);\nDeclare @DynamicJoin_SQL nvarchar(max);\nDECLARE @nbr_statements INT;\nDECLARE @i INT = 1;\nDeclare @LookupJoinColumn varchar(100);\nDeclare @OptionSetName_SQL nvarchar(max);\nDeclare @FinalQuery nvarchar(max);\nSET @OptionSetName_SQL = 'SELECT ROW_NUMBER() OVER(ORDER BY (SELECT NULL)) AS Sequence1, inn.column_name as ColumnName\n\t\t\t\t\t\t  from (  select distinct OptionSetName as column_name\n\t\t\t\t\t\t\t\t  from '+@DBName+'.[dbo].[GlobalOptionsetMetadata]\n\t\t\t\t\t\t\t\t  where EntityName = '''+@TableName+''' ) inn';\n\nINSERT into #OptionSetName_tbl (Sequence1,ColumnName) \nExec sp_executesql @OptionSetName_SQL\n--select * from  #OptionSetName_tbl\nSET @nbr_statements = (SELECT COUNT(*) FROM #OptionSetName_tbl);\nSET @GlobalOSPvt_SQL = 'CREATE or alter VIEW TMP_VIEW\nAS WITH GlobalOSPvt as (\nSELECT * \nFROM\n( SELECT *\nFROM '+@DBName+'.[dbo].[GlobalOptionsetMetadata]\n) AS tbl\nPIVOT\n( MAX([OPTION])\nFOR OptionSetName IN ('\n\n\nWHILE   @i <= @nbr_statements\n\nBegin\n\tSELECT @LookupJoinColumn = ColumnName FROM #OptionSetName_tbl WHERE Sequence1 = @i;\n\tif (@i = 1 )\n\t\tSET @GlobalOSPvt_SQL = @GlobalOSPvt_SQL + @LookupJoinColumn;\n\telse\n\t\tSET @GlobalOSPvt_SQL = @GlobalOSPvt_SQL +','+@LookupJoinColumn;\n\tSET     @i +=1;\nEND\n\n--SET @GlobalOSPvt_SQL = @GlobalOSPvt_SQL +') ) as pvt) select cont.*' \n--SET @GlobalOSPvt_SQL = @GlobalOSPvt_SQL +') ) as pvt) select row_number() OVER (ORDER BY '+ @TableName+'id) + 1000 AS '+ @TableName+'Key,inn2.*'\nSET @GlobalOSPvt_SQL = @GlobalOSPvt_SQL +') ) as pvt) select inn2.*'\nSET @i = 1 \n\n/*WHILE   @i <= @nbr_statements\nBegin\n       SELECT @LookupJoinColumn = ColumnName FROM #OptionSetName_tbl WHERE Sequence1 = @i;\n       --if (@i = 1 )\n       --     SET @GlobalOSPvt_SQL = @GlobalOSPvt_SQL + 'cont.'+@LookupJoinColumn;\n       --else\n       SET @GlobalOSPvt_SQL = @GlobalOSPvt_SQL +','+'LocalizedLabel_'+@LookupJoinColumn;\n       SET     @i +=1;\nEND\nSET @i = 1*/\n--SET @GlobalOSPvt_SQL = @GlobalOSPvt_SQL + ','+ @TableName+' from (select row_number() OVER (\tPARTITION BY id ORDER BY versionnumber) AS row_num,cont.*'--+ @TableName+'id'\nSET @GlobalOSPvt_SQL = @GlobalOSPvt_SQL +' from (select row_number() OVER (\tPARTITION BY id ORDER BY versionnumber) AS row_num,cont.*'--+ @TableName+'id'\nWHILE   @i <= @nbr_statements\nBegin\n\tSELECT @LookupJoinColumn = ColumnName FROM #OptionSetName_tbl WHERE Sequence1 = @i;\n\tSET @GlobalOSPvt_SQL = @GlobalOSPvt_SQL + ',glob'+cast(@i as varchar)+'.LocalizedLabel as LocalizedLabel_'+@LookupJoinColumn\n\tSET     @i +=1;\nEnd\n----\nSET @i = 1 \n\nSET @DynamicJoin_SQL = ' from '+@DBName+'.'+@SchemaName+'.'+@TableName+' cont'\nWHILE   @i <= @nbr_statements\nBegin\n\n\tSELECT @LookupJoinColumn = ColumnName FROM #OptionSetName_tbl WHERE Sequence1 = @i;\n\t--SET @GlobalOSPvt_SQL = \t@GlobalOSPvt_SQL + ',glob'+cast(@i as varchar)+'.LocalizedLabel as LocalizedLabel_'+@LookupJoinColumn\n\tSET @DynamicJoin_SQL = @DynamicJoin_SQL + ' left join GlobalOSPvt glob'+cast(@i as varchar)+'\n\t\t    on cast(cont.'+@LookupJoinColumn+' as varchar) = cast(glob'+cast(@i as varchar)+'.'+@LookupJoinColumn+' as varchar)'\n\n\t--select @GlobalOSPvt_SQL\n\t--select @DynamicJoin_SQL\n\tSET     @i +=1;\n\t\nEnd \nSET @DynamicJoin_SQL = @DynamicJoin_SQL + ')inn2 WHERE row_num = 1'\n--select @GlobalOSPvt_SQL\n--select @DynamicJoin_SQL\nSET @FinalQuery = @GlobalOSPvt_SQL + @DynamicJoin_SQL\n--select @FinalQuery\nExec sp_executesql @FinalQuery\n\nGO\n\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "ws-ent-syn-serverlessdb-001",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}