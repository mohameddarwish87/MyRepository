{
	"name": "dbo_SP_LoadDim_EventDetails",
	"properties": {
		"folder": {
			"name": "ws-ent-syn-serverlessdb-001/StoredProcedure"
		},
		"content": {
			"query": "/****** Object:  StoredProcedure [dbo].[SP_LoadDim_EventDetails]    Script Date: 12/22/2022 5:02:11 AM ******/\nSET ANSI_NULLS ON\nGO\n\nSET QUOTED_IDENTIFIER ON\nGO\n\n\n\nCREATE or Alter  PROCEDURE [dbo].[SP_LoadDim_EventDetails]\n( @GetNewWaterMark bit=0, @RowValidFrom Datetime2(7)='1900-01-01 00:00:00.0000000'\n)\nAS\nBegin \n\tIF @GetNewWaterMark>0\n\tBEGIN\n\tSELECT isnull(max(RowValidFrom),@RowValidFrom) AS RowValidFrom\n\t\t\tFROM [dbo].ws_notification\n\t\t\tWHERE CAST(RowValidFrom As datetime2(7))>@RowValidFrom\n\tEND\n\tELSE\n\t\tWITH CTE_EventDetails\n\t\tAS (\n\t\t\t SELECT id AS [NotificationID]\n\t\t\t\t,ws_region AS [EventRegion]\n\t\t,ws_city AS [EventCity]\n\t\t,ws_suburb AS [EventSuburb]\n\t\t,ws_streetaddress AS [EventStreet]\n\t\t,ws_postalcode   AS  [EventPostalCode]\n\t\t,ws_countryidname AS [EventCountry]\n\t\t,ws_causeofeventidname [EventCause]\n\t\t,convert(datetimeoffset,ws_dateandtimeofevent) as [EventDateTime]\n\t\t,ws_causeofeventcategoryidname [EventCauseCategoryName]\n\t\t,ws_causeofeventsubcategoryidname [EventCauseSubCategoryName]\n\t\t,ws_policeeventnumber [EventPoliceNumber]\n\t\t,ws_injurymechanismcategoryidname [InjuryMechanismCategory]\n\t\t,ws_injurymechanismidname [InjuryMechanismName]\n\t\t,ws_causeofeventid as [EventCauseID]\n\t\t,ws_causeofeventcategoryid as [EventCauseCategoryID]--sp-dataops-cicd-dev\n\t\t,ws_causeofeventsubcategoryid as [EventCauseSubCategoryID]\n\t\t,ws_injurymechanismcategoryid as [InjuryMechanismCategoryID]\n\t\t,ws_injurymechanismid as [InjuryMechanismID]\n\t\t,row_number() OVER (\n\t\t\tPARTITION BY id ORDER BY versionnumber DESC\n\t\t\t) AS row_num\n\tFROM  [dbo].ws_notification\n\tWHERE CAST(RowValidFrom as datetime2(7)) > @RowValidFrom\n\tAND RowIsCurrent='true'\n\n   \n\t)\nSELECT \n\t \n\t [EventDateTime]\n\t,[EventRegion]\n\t,[EventCity]\n\t,[EventSuburb]\n\t,[EventStreet]\n\t,[EventPostalCode]\n\t,[EventCountry]\n\t,[EventCause]\n\t,[EventCauseCategoryName]\n\t,[EventCauseSubCategoryName]\n\t,[InjuryMechanismCategory]\n\t,[InjuryMechanismName]\n\t--[Event Police Number]\n\t,[NotificationID]\n\n\t\t --,[Event Cause ID]\n\t\t --,[Event Cause Category ID]\n\t\t --,[Event Cause SubCategory ID]\n\t\t --,[Injury Mechanism Category ID]\n\t\t --,[Injury Mechanism ID]\n\t\nFROM CTE_EventDetails\nWHERE row_num = 1\nAND [NotificationID] is not null\n\nUNION \n\nSELECT \n\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\n'UNKNOWN'\n\nEND\nGO\n\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "wsentsynserverlessdb001",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}