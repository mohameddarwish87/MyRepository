{
	"name": "SP_LoadLink_Notification_Contact",
	"properties": {
		"folder": {
			"name": "ws-ent-syn-serverlessdb-001/StoredProcedure"
		},
		"content": {
			"query": "/****** Object:  StoredProcedure [dbo].[SP_LoadLink_Notification_Contact]    Script Date: 12/22/2022 5:14:57 AM ******/\nSET ANSI_NULLS ON\nGO\n\nSET QUOTED_IDENTIFIER ON\nGO\n\n\nCREATE OR ALTER   PROCEDURE [dbo].[SP_LoadLink_Notification_Contact]\n(\n@GetNewWaterMark bit=0,@RowValidFrom Datetime2(7)='1900-01-01 00:00:00.0000000'\n)\nAS\nBegin \n\tIF @GetNewWaterMark>0\n\tBEGIN\n\tSELECT isnull(max(RowValidFrom),@RowValidFrom) AS RowValidFrom\n\t\t\tFROM [dbo].[ws_notification] a\n\t\t\tWHERE CAST(RowValidFrom As datetime2(7))>@RowValidFrom\n\tEND\n\tELSE\nWITH CTE_Connections AS (\n\nSELECT [record1id]                      AS 'Notification ID',\n                [record2id]                      AS 'Contact ID',\n                [record2roleidname]              AS 'Role',\n                record2id_entitytype             AS 'EntityType',\n\t\t\t\tisnull([description],'')         As 'Description',\n                Row_number()\n                  OVER (\n                    partition BY id\n                    ORDER BY versionnumber DESC) AS ROW_RUM\n         FROM   [dbo].[connection] Conn\n         WHERE  record1id_entitytype = 'ws_notification'\n                AND record2id_entitytype = 'contact'\n\t\t\t\tAND  CAST(Conn.RowValidFrom as datetime2(7)) > @RowValidFrom \n         UNION\n         SELECT [id]                             AS 'Notification ID',\n                [ws_primarypcbu]                 AS 'Contact ID',\n                'Primary PCBU'                   AS 'Role',\n                'contact'                        AS 'EntityType',\n\t\t\t\t''                               As 'Description',\n                Row_number()\n                  OVER (\n                    partition BY id\n                    ORDER BY versionnumber DESC) AS ROW_RUM\n         FROM   [dbo].[ws_notification] a\n         WHERE  [ws_primarypcbu_entitytype] = 'contact'  and [ws_primarypcbu] IS NOT NULL\n\t\t AND  CAST(a.RowValidFrom as datetime2(7)) > @RowValidFrom \n\n         UNION\n         SELECT [id]                             AS 'Notification ID',\n                [ws_primaryparty]                AS 'Contact ID',\n                'Primary Party'                  AS 'Role',\n                'contact'                        AS 'EntityType',\n\t\t\t\t''                               As 'Description',\n                Row_number()\n                  OVER (\n                    partition BY id\n                    ORDER BY versionnumber DESC) AS ROW_RUM\n         FROM   [dbo].[ws_notification] a\n         WHERE  [ws_primaryparty_entitytype] = 'contact' and [ws_primaryparty] IS NOT NULL\n\t\t AND  CAST(a.RowValidFrom as datetime2(7)) > @RowValidFrom \n     AND a.RowIsCurrent='true'\n\n\t)\n\t   \tSELECT  \n\t   [notification id] as [NotificationID],\n       [Contact ID] as [ContactID],\n       role as Role,\n\t   EntityType,\n\t   Description\n      FROM   CTE_Connections Conn\n    WHERE  row_rum = 1 \n\tUNION \n  SELECT \n  'UNKNOWN',\n  'UNKNOWN',\n  Null,\n  NUll,\n  Null\n\n\n\tEnd\nGO\n\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "wsentsynserverlessdb001",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}