{
	"name": "dbo_SP_LoadFact_HSWANotification",
	"properties": {
		"folder": {
			"name": "ws-ent-syn-serverlessdb-001/StoredProcedure"
		},
		"content": {
			"query": "/****** Object:  StoredProcedure [dbo].[SP_LoadFact_HSWANotification]    Script Date: 12/22/2022 5:13:39 AM ******/\nSET ANSI_NULLS ON\nGO\n\nSET QUOTED_IDENTIFIER ON\nGO\n\n\nCREATE OR ALTER  PROCEDURE [dbo].[SP_LoadFact_HSWANotification]\n( @GetNewWaterMark bit=0,@RowValidFrom Datetime2(7)='1900-01-01 00:00:00.0000000'\n)\nAS\n\nBegin \n\tIF @GetNewWaterMark>0\n\tBEGIN\n\tSELECT isnull(max(RowValidFrom),@RowValidFrom) AS RowValidFrom\n\t\t\tFROM [dbo].ws_notification \n\t\t\tWHERE CAST(RowValidFrom As datetime2(7))>@RowValidFrom\n\tEND\n\tELSE\nWITH CTE\nAS (\n\tSELECT A.ws_notificationid [HSWANotificationID]\n\t\t,ws_notificationnumber [HSWANotificationNumber]\n\t\t,b.LocalizedLabel AS [Status]\n\t\t,C.LocalizedLabel AS [StatusReason]\n\t\t,ws_guardiannumberhswanotification AS [GuardianFileName]\n\t\t,CONVERT(DATE, ws_dateofnotification) AS [NotificationDate]\n\t\t,CONVERT(DATE, ws_dateallocatedtooffice) AS [OfficeAllocatedDate]\n\t\t,CONVERT(DATE, ws_senttotriageon) AS [SenttoTriageDate]\n\t\t,CONVERT(DATE, ws_dateofpcbucontact) AS [PCBUCallDate]\n\t\t,ws_pcbunotified AS [IsPCBUNotified]\n\t\t,ws_sceneheld AS [Sceneheld]\n\t\t,ws_worksafejurisdiction AS [WorkSafeResponsibility]\n\t\t,ws_highprofile AS [HighPublicInterest]\n\t\t,ws_submittedbycompliancecertifier AS [IsSubmittedbyComplianceCertifier]\n\t\t,ws_existinghswanotification AS [ExistingHSWANotificationID]\n\t\t,ROW_NUMBER() OVER (\n\t\t\tPARTITION BY ID ORDER BY versionnumber DESC\n\t\t\t) AS ROW_RUM\n\t\t--Keys to lookup\n\t\t,ws_primarypcbu AS [PrimaryPCBUContact/AccountID] --Contact/Account \n\t\t,ws_officeallocatedto AS [AllocatedOfficeID]\n\t\t,ws_agencyreceivedfrom AS [ReceivedFromExternalAgencyID]\n\t\t,ws_agencysentto AS [SendToExternalAgencyID]\n\t\t,ws_sendfatalnotificationto AS [FatalNotificationSendToOfficeID]\n\t\t,ws_primaryparty AS [PrimaryPartyID] -- Contact \n\t\t,ws_outcomeid AS [OutcomeID]\n\t\t,ws_outcomereasonid AS [OutcomeReasonID]\n\t\t,ws_previousoutcomeid AS [PreviousOutcomeID]\n\t\t,ws_previousoutcomereasonid AS [PreviousOutcomeReasonID]\n\t\t,E.DLDim_OfficeKey as [AllocatedOfficeKey]\n\t\t,EE.DLDim_OfficeKey as [FatalNotificationSendToOfficeKey]\n\t\t,ISnull(F.[DLDim_BusinessKey],P.[DLDim_ContactKey]) AS PCBUKey\n\t\t,G.DLDim_IndustryKey AS [IndustryKey]\n\t\t,H.[DLDim_EventDetailsKey] as [EventKey]\n\t\t--,I.[Injury_Mechanism_Key]\n\t\t,Outcome.[DLDim_Notification_OutcomeKey] as [NotificationOutcomeKey]\n\t\t,OutcomeReason.[DLDim_Notification_Outcome_ReasonKey] as [NotificationOutcomeReasonKey]\n\t\t,PreviousOutcome.[DLDim_Notification_OutcomeKey] as [PreviousOutcomeKey]\n\t\t,PreviousOutcomeReason.[DLDim_Notification_Outcome_ReasonKey] as  [PreviousOutcomeReasonKey]\n\t\t,K.[DLDim_NotificationMetaDataKey] as [NotificationMetadataKEY]\n\t\t,L.[DLDim_NotificationOptionsDataKey] as NotificationOptionSetKEY\n\t\t,M.[DLDim_NotificationSIRPKey] as NotificationSIRPKey\n\t\t,n.[DLDim_External_AgencyKey] AS ReceivedFromAgencyKey\n\t\t,o.[DLDim_External_AgencyKey] AS SentToAgencyKey\n\t\t,PP.[DLDim_ContactKey] as ContactKey\n\tFROM [dbo].ws_notification A\n\tLEFT JOIN [dbo].[StateMetadata] B ON A.statecode = b.STATE\n\t\tAND b.EntityName = 'ws_notification'\n\t\tAND a.RowIsCurrent='true'\n\tLEFT JOIN [dbo].StatusMetadata C ON A.statuscode = C.STATUS\n\t\tAND c.EntityName = 'ws_notification'\n\t\tAND a.RowIsCurrent='true'\n\t LEFT JOIN [Notification_DataMart].[Notification].[Dim_Office] E on A.ws_officeallocatedto=E.[OfficeID] AND E.RowIsCurrent='true'\n\t LEFT JOIN [Notification_DataMart].[Notification].[Dim_Office] EE on A.ws_sendfatalnotificationto=EE.[OfficeID] AND EE.RowIsCurrent='true'\n\t LEFT JOIN [Notification_DataMart].[Notification].[Dim_Business] F ON A.[ws_primarypcbu]=F.[BusinessID] AND F.RowIsCurrent='true'\n\t LEFT JOIN [Notification_DataMart].[Notification].[Dim_Industry] G ON F.[BusinessIndustryID]=G.[IndustryID] AND G.RowIsCurrent='true'\n\t-- LEFT JOIN Contact \n\tLEFT JOIN [Notification_DataMart].[Notification].[Dim_EventDetails] H on A.ws_notificationid=H.[NotificationID] AND H.RowIsCurrent='true'\n\tLEFT JOIN [Notification_DataMart].[Notification].[Dim_Notification_Outcome] Outcome on Outcome.[NotificationOutcomeID]=A.ws_outcomeid  AND Outcome.RowIsCurrent='true'\n\tLEFT JOIN [Notification_DataMart].[Notification].[Dim_Notification_Outcome_Reason] OutcomeReason On OutcomeReason.[NotificationOutcomeReasonID]=ws_outcomereasonid AND OutcomeReason.RowIsCurrent='true'\n\tLEFT JOIN [Notification_DataMart].[Notification].[Dim_Notification_Outcome] PreviousOutcome on PreviousOutcome.[NotificationOutcomeID]=A.ws_outcomeid AND PreviousOutcome.RowIsCurrent='true'\n\tLEFT JOIN [Notification_DataMart].[Notification].[Dim_Notification_Outcome_Reason] PreviousOutcomeReason On PreviousOutcomeReason.[NotificationOutcomeReasonID]=ws_outcomereasonid AND PreviousOutcomeReason.RowIsCurrent='true'\n\tLEFT JOIN [Notification_DataMart].[Notification].[Dim_NotificationMetaData] K ON K.[NotificationID]=A.ws_notificationid AND K.RowIsCurrent='true'\n\tLEFT JOIN [Notification_DataMart].[Notification].[Dim_NotificationOptionsData] L on L.[NotificationID]=A.ws_notificationid AND L.RowIsCurrent='true'\n\tLEFT JOIN [Notification_DataMart].[Notification].[Dim_NotificationSIRP]M on M.[NotificationID]=A.ws_notificationid AND M.RowIsCurrent='true'\n\tLEFT JOIN [Notification_DataMart].[Notification].[Dim_External_Agency]n on n.[ExternalAgencyID]=A.ws_agencyreceivedfrom AND n.RowIsCurrent='true'\n\tLEFT JOIN [Notification_DataMart].[Notification].[Dim_External_Agency] o on o.[ExternalAgencyID]=A.ws_agencysentto AND o.RowIsCurrent='true'\n\tLEFT JOIN [Notification_DataMart].[Notification].[Dim_Contact] P ON p.[ContactId]=A.ws_primarypcbu AND P.RowIsCurrent='true'\n\tLEFT JOIN [Notification_DataMart].[Notification].[Dim_Contact] PP ON PP.[ContactId]=A.ws_primaryParty AND PP.RowIsCurrent='true'\n\tWHERE CAST(a.RowValidFrom as datetime2(7)) > @RowValidFrom)\n\nSELECT \n\n\t[HSWANotificationID]\n\t,[HSWANotificationNumber]\n\t,[Status]\n\t,[STATUSReason]\n\t,[GuardianFileName]\n\t,[NotificationDate]\n\t,[OfficeAllocatedDate]\n\t,[SentTOTriageDate]\n\t,[IsPCBUNotified]\n\t,[PCBUCallDate]\n\t,[Sceneheld]\n\t,[WorkSafeResponsibility]\n\t,[HighPublicInterest]\n\t,[ExistingHSWANotificationID]\n\t,[IsSubmittedbyComplianceCertifier]\n\t--Keys to lookup\n\t,[PrimaryPartyID]\n\t,[PrimaryPCBUContact/AccountID]\n\t,[AllocatedOfficeKey]\n\t,[FatalNotificationSendToOfficeKey]\n\t,PCBUKey\n\t,IndustryKey\n\t,EventKey\n\t,NotificationOutcomeKey\n\t,NotificationOutcomeReasonKey\n\t,PreviousOutcomeKey\n\t,PreviousOutcomeReasonKey\n\t,NotificationMetadataKEY\n\t,NotificationOptionSetKEY\n\t,NotificationSIRPKey\n\t,ReceivedFromAgencyKey\n\t,SentToAgencyKey\n\t,ContactKey\nFROM CTE\nWHERE ROW_RUM = 1 and HSWANotificationID is  not null\nUNION \n\nSELECT \n'UNKNOWN',\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull,\nNull\n\n\nEND\nGO\n\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "wsentsynserverlessdb001",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}